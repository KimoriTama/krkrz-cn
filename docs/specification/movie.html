<html>
<head>
<meta HTTP-EQUIV="CONTENT-TYPE" CONTENT="TEXT/HTML; CHARSET=UTF-8">
<title>吉里吉里Z 功能规格书 / 视频播放功能</title>
<link rel="stylesheet" href="styles-site.css" type="text/css" />
</head>
<body>
<a name="top"></a>
<div id="top_link"><a href="./index.html">Topへ</a></div>
<div id="container">
<div id="title-banner">
<h1>视频播放功能</h1>
</div>

<div class="content">
<p>记载了吉里吉里Z 支持的视频播放功能。</p>
<h3>目录</h3>
<p><a href="#spec">规格</a><br />
<a href="#mode">模式</a><br />
<a href="#trickplay">特殊播放功能</a><br />
<a href="#preparevideo">关于视频播放准备 ( preparevideo )</a><br />
<a href="#layermode">关于在层模式下指定层</a><br />
<a href="#end_of_video">视频结尾处的行为</a><br />
<a href="#layer_alpha">关于在图层模式下看不到视频的问题</a><br />
<a href="#mixer_mode">混合播放</a><br />
<a href="#seek_to_keyframe">关键帧和查找</a><br />

</p>
<br />

<div class="title_bar"><a name="spec">规格</a></div>
<br />
<table frame="box" rules="all">
	<tbody>
		<tr>
			<td rowspan="3">模式</td>
			<td>覆盖模式</td>
			<td>使用视频覆盖显示视频的模式</td>
		</tr>
		<tr>
			<td>层模式</td>
			<td>吉里吉里内的图层播放动画的模式</td>
		</tr>
		<tr>
			<td>混合模式</td>
			<td>使用VMR9+Direct3显示视频的模式</td>
		</tr>

		<tr>
			<td rowspan="4">特殊播放功能</td>
			<td>区间循环</td>
			<td>能够在指定帧之间循环</td>
		</tr>
		<tr>
			<td>周期事件</td>
			<td>在指定帧中触发事件的能力</td>
		</tr>
		<tr>
			<td>指定播放速度</td>
			<td>指定视频播放速度的功能</td>
		</tr>
		<tr>
			<td>多音频</td>
			<td>选择并播放多路复用声音的功能</td>
		</tr>

		<tr>
			<td>声音平衡<br />(全景)</td>
			<td>-100000 ～ 0<br /> ～ 100000</td>
			<td>-100000完全靠左，0居中，100000完全靠右。<br />
				如果您正在播放立体声源，则全景必须<br />
				通过衰减左右任一通道来实现。</td>
		</tr>
		<tr>
			<td>声音音量</td>
			<td>0 ～ 100000</td>
			<td>表示完全静音，100000表示100%音量</td>
		</tr>
		<tr>
			<td>音频流</td>
			<td>依赖于内容</td>
			<td>选择要播放的音频流</td>
		</tr>
		<tr>
			<td>播放速度</td>
			<td>＞0</td>
			<td>可设置的值取决于DirectShow过滤器。<br />
			有声音的情况下，2.0≧速度＞0。<br />
			1.0为等倍速。</td>
		</tr>

		<tr>
			<td rowspan="7">取得可能値</td>
			<td>フレームレート</td>
			<td>1秒当りのフレーム数</td>
		</tr>
		<tr>
			<td>現在のフレーム</td>
			<td>現在表示しているフレーム。<br />
			表示しているフレーム番号と完全に一致する保証はない。</td>
		</tr>
		<tr>
			<td>現在の再生時間</td>
			<td>動画の最初からの動画内での経過時間。</td>
		</tr>
		<tr>
			<td>画像サイズ</td>
			<td>幅と高さ</td>
		</tr>
		<tr>
			<td>音声ストリーム数</td>
			<td>多重化されている音声ストリームの数</td>
		</tr>
		<tr>
			<td>全フレーム数</td>
			<td>動画が保持しているフレームの数</td>
		</tr>
		<tr>
			<td>合計時間</td>
			<td>動画の合計時間</td>
		</tr>

		<tr>
			<td rowspan="4">イベント</td>
			<td>フレーム更新</td>
			<td>ビデオフレームが更新された後に発生</td>
		</tr>
		<tr>
			<td>Periodイベント</td>
			<td>通常ループ終端、セグメントループ終端、<br />
			設定したピリオドイベント、再生準備完了時に発生。</td>
		</tr>
		<tr>
			<td>ステータス変更</td>
			<td>再生状態が変更された時に発生</td>
		</tr>

	</tbody>
</table>

<br />
<br />


<div class="title_bar"><a name="mode">模式</a></div>
<br />
<table frame="box" rules="all">
	<thead><tr><td>种类</td><td>说明</td></tr></thead>
	<tbody>
		<tr>
			<td>覆盖模式</td>
			<td>这是一种使用视频叠加显示视频的模式。<br />
				比吉里吉里其他任何图层都更靠前。<br />
				在大多数情况下，影片的播放负载是最轻的。。<br />
				如果只是简单的播放视频然后停止，那么使用覆盖模式是一个很好的选择。<br />
				但是，在Windows Vista 和 Windows XP 中，吉里吉里的绘制模式为DirectDraw时，在某些环境中，如果在覆盖模式下进行放大，则会出现无法完全放大的现象（出现锯齿现象）。<br />
				因此，最好不要在Windows Vista中使用覆盖模式。</td>
		</tr>
		<tr>
			<td>层模式</td>
			<td>在吉里吉里指定的图层上播放视频的模式。<br />
				环境依赖性较低，允许在指定帧之间循环（分段循环）和处理指定帧（周期事件）等功能。<br />
				唯一的难点是CPU负载比其它模式更高。<br />
				也不能进行缩放。</td>
		</tr>
		<tr>
			<td>混合模式</td>
			<td>使用VMR9+Direct3D显示视频的模式，作为覆盖模式的替代方案而添加。<br />
				如果显卡具有视频播放辅助功能且支持编解码器，则可以使用显卡的视频播放辅助功能进行播放。<br />
				还可避免Windows Vista放大时出现锯齿问题。<br />
				还可以与指定图层混合或缩放。 <br />
				必须使用DirectX 9或更高版本。</td>
		</tr>
	</tbody>
</table>

<br />
<br />

<div class="title_bar"><a name="trickplay">特殊播放功能</a></div>
<br />
<table frame="box" rules="all">
	<thead><tr><td>种类</td><td>功能</td></tr></thead>
	<tbody>
		
另外，当想要字幕配合动画时，也可以在字幕的开始帧上设定句点事件，等待事件后显示文字。
另外，使用此功能，可以在指定帧中使用SE发出声音，而不在视频本身中输入声音。
播放速度控制
可以指定视频的播放速度。
指定
1.
0是通常的播放速度，0.

5是一半的播放速度，2是2倍的播放速度。
可能的值取决于DirectShow过滤器（Codec）。
多音频
MPEG I允许多个音频流多路复用，因此可以利用这些音频流。
此功能允许您播放任何音频流。
例如，可以只准备BGM、BGM+声音等流，用户可以指定在哪个模式下播放。
不过，音频流的切换有2秒左右的时滞，因此不太适合交互应用。
可以用于根据上述用户的选择和场景而改变动画声音的用途。

		<tr>
			<td>分段循环</td>
			<td>在指定帧之间循环的功能。<br />
				要使用此功能，您必须在要循环返回到视频文件本身的帧上设置关键帧。<br />
				如果没有关键帧，则不会按预期循环。</td>
		</tr>
		<tr>
			<td>周期事件</td>
			<td>一种可以在指定的帧中触发事件并对其进行某种处理的功能。<br />
			イ事件发生时，通过查找到相隔较远的帧，可以跳过中间的帧，使视频看起来像是连接的。<br />
			また、動画にあわせて字幕を出したい時なども、字幕の開始フレームにピリオドイベントを設定し、イベントを待って文字を表示することで実現可能です。<br />
			他に、この機能を使えば、動画自体には音を入れず、指定フレームでSEを使って音を鳴らすことも可能です。</td>
		</tr>
		<tr>
			<td>再生速度コントロール</td>
			<td>動画の再生速度が指定可能です。<br />
			1.0 を指定すると通常の再生速度、0.5 では半分の再生速度、2では2倍の再生速度になります。<br />
			設定可能な値は DirectShowのフィルタ (Codec) に依存します。</td>
		</tr>
		<tr>
			<td>マルチオーディオ</td>
			<td>MPEG I では、複数のオーディオストリームを多重化可能なため、それを利用する機能です。<br />
			この機能では、任意のオーディオストリームを再生することが可能です。<br />
			たとえば、BGMのみ、BGM+声などのストリームを準備しておき、ユーザーがどのモードで再生するか指定可能にすることなどが出来ます。<br />
			ただ、オーディオストリームの切り替えには2秒程度のタイムラグがあるため、あまりインタラクティブな用途には向いていません。<br />
			上記のユーザーによる選択やシーンによって動画音声が変わるような用途に使えます。</td>
		</tr>

	</tbody>
</table>

<br />
<br />

<div class="title_bar"><a name="preparevideo">動画再生準備について ( preparevideo )</a></div>
<p>preparevideo は、動画の1フレーム目を指定されたレイヤーに描画します。<br />
これは、意図しない画像(メモリ上のごみや前回の画像など)が画面上に表示されるのを防ぐ目的で利用されます。<br />
つまり、再生対象としたレイヤーを非表示にして、動画を openvideo で開いた後、preparevideo をコールし、wp で準備完了を待ち、準備できた後に再生対象レイヤーを表示状態にするような処理を記述することで、表示した時に動画の1フレーム目を表示することが出来ます。<br />
なお、この機能はレイヤーモードの時のみ意味を持ちます。<br />
</p>

<br />
<br />

<div class="title_bar"><a name="layermode">レイヤーモードでのレイヤー指定について</a></div>
<p>レイヤーモードで動画を再生する場合、videolayer を使用して、描画対象レイヤーを指定します。<br />
videolayer では、slotとchannel, page, layer が指定できます。 <br />
slot は、se の buf に相当するもので、異なるビデオを同時に再生する時に、どのビデオに対する操作かを特定するためにあります。<br />
複数の動画を同時に再生することはほとんどないと思いますので、通常は記述を省略し、0 が指定されるようにしておけば問題ありません。<br />
channel は、出力するレイヤーを指定するためにあります。<br />
1つの動画に付き2つまで出力するレイヤーを指定できるので、そのどちらに対する指定かを特定するために利用します。<br />
2つ指定可能になっているのは、トランジションを利用するためです。<br />
動画再生中にトランジションを実行すると、表と裏のレイヤーが入れ替わるため、片方にしか出力していないと、動画が非表示になってしまいます。<br />
これを避けるため、動画再生中にトランジションを行う場合は、チャンネルの1と2に表と裏のレイヤーを設定しておきます。トランジションを行わないのであれば、表面だけ指定しておけば問題ありません。<br />
</p>

<br />
<br />

<div class="title_bar"><a name="end_of_video">動画終端での振る舞い</a></div>
<p>ループを指定せずに動画を再生すると、最後まで再生したら動画は停止します。<br />
動画の最後のフレームを表示したままゲームを進行したい場合、この動作は好ましくありません。<br />
これを回避する最も簡単な方法はレイヤーモードを使用することです。<br />
レイヤーモードでは、レイヤーに対して動画が描画されるため、最後のフレームの画像がそのままレイヤーに残ります。<br />
そのため、特に意識することなく、最後のフレームを表示したままゲームを進行出来ます。<br />
オーバーレイやミキサーの場合は、停止すると表示が消えてしまうため、最終フレームに達する前に一時停止しなければなりません。<br />
これは、ピリオドイベントで実現できますが、本当に最終フレームにしてしまうと、停止してしまう可能性があるため、動画の末尾に数フレームダミーフレームを入れておき、少し通り越しても大丈夫なようにしておいた方が良いです。<br />
</p>

<br />
<br />

<div class="title_bar"><a name="layer_alpha">レイヤーモードで動画が表示されない現象について</a></div>
<p>動画の再生対象としたレイヤーの表示タイプがアルファなどになっていると、動画が表示されないという事態が発生します。<br />
これは、動画がアルファチャンネルを持っていない場合、アルファチャンネルの位置に不定データが書き込まれるためです。<br />
レイヤー表示タイプがアルファになっている場合、この不定データがアルファ値として扱われるため、完全に透明になってしまったりします。<br />
これを回避するためには、再生対象レイヤーの表示タイプをopaqueにしてやります。<br />
そうすると動画が表示されるようになります。<br />
ただ、KAGではopaqueにし辛いので、代わりに freeimage を呼んでも同様の効果が得られるようです。<br />
</p>

<br />
<br />

<div class="title_bar"><a name="mixer_mode">ミキシング再生</a></div>
<p>ミキサーモードはその名の通り、他のレイヤーと動画をミキシングして再生することを実現できます。<br />
ミキサーモードでミキシングに関係して指定できるのは、背景色、ブレンド率、ミキシング対象レイヤーです。<br />
ミキシング対象レイヤーは、設定した瞬間の画像と動画がミキシングされます。<br />
そのため、ミキシング対象レイヤーが更新されても、再度設定しない限り内容は更新されません。<br />
ただ、毎フレームの更新時に設定をコールすると、かなりCPU負荷が高くなります。<br />
CPU負荷を抑えるために、設定する場合は、更新された時のみに限定した方が良いです。<br />
背景色は、ブレンド率を1.0未満にした場合にブレンドされる色です。<br />
背景色を黒などに設定し、ブレンド率を変化させることで、フェードイン/アウトが実現できます。<br />
当然、ミキシング対象レイヤーとのフェードイン/アウト可能です。<br />
ミキシング対象レイヤーとのブレンド率やレイヤー位置はレイヤーの情報が使われます。<br />
つまり、表示位置はレイヤーの位置にブレンド率はレイヤーの不透明度に依存します。<br />
ただ、レイヤーとのブレンドは毎回指定する必要があるという仕様から、レイヤーとフェードイン/アウトをするとCPU負荷が高くなってしまいます。<br />
</p>

<br />
<br />

<div class="title_bar"><a name="seek_to_keyframe">キーフレームとシーク</a></div>
<p>吉里吉里ではシークを高速に行うため、シーク可能位置をキーフレームに限定しています。<br />
キーフレーム以外のフレームを指定した場合、指定フレームに最も近いキーフレームへシーク処理が行われます。<br />
ただし、この動作は Codec 依存のため、しばしば意図しない動作が行われます。<br />
そのため、シークを行うフレームへは必ずキーフレームを設定するようにした方が良いです。<br />
</p>

<br />
<br />



<br />
</div>
</div>

</body>
</html>

